{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://openjobspec.org/schemas/v1/federation.json",
  "title": "OJS Federation Attributes",
  "description": "JSON Schema for multi-region federation attributes carried in the job envelope's meta object. These attributes enable cross-region job routing, failover, and tracking.",
  "type": "object",
  "definitions": {
    "federationMeta": {
      "title": "Federation Metadata",
      "description": "Federation-specific attributes in the job meta object, prefixed with ojs.federation.",
      "type": "object",
      "properties": {
        "ojs.federation.federation_id": {
          "title": "Federation ID",
          "description": "A UUIDv7 identifier assigned by the federated client at enqueue time. Stable across regions â€” replicated copies share the same federation_id.",
          "type": "string",
          "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
          "examples": ["01912e4a-7b3c-7def-8a12-abcdef123456"]
        },
        "ojs.federation.region": {
          "title": "Target Region",
          "description": "The region where this job MUST execute (geo-pin). When set, the routing strategy is treated as geo-pin regardless of region_affinity value.",
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "minLength": 1,
          "maxLength": 64,
          "examples": ["us-east-1", "eu-west-1", "ap-south-1"]
        },
        "ojs.federation.region_affinity": {
          "title": "Routing Strategy",
          "description": "The routing strategy for this job. Determines how the federation layer selects a target region.",
          "type": "string",
          "enum": ["affinity", "overflow", "geo-pin"],
          "default": "affinity",
          "examples": ["affinity", "overflow", "geo-pin"]
        },
        "ojs.federation.replicated_from": {
          "title": "Replicated From",
          "description": "The region ID from which this job was replicated. Set by the replication layer, not by clients. A job with this attribute set MUST NOT be replicated again.",
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "minLength": 1,
          "maxLength": 64,
          "examples": ["us-east-1"]
        }
      },
      "additionalProperties": true
    },
    "regionEntry": {
      "title": "Region Registry Entry",
      "description": "A single region in the federation registry.",
      "type": "object",
      "required": ["id", "url"],
      "properties": {
        "id": {
          "title": "Region ID",
          "description": "Unique region identifier.",
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "minLength": 1,
          "maxLength": 64,
          "examples": ["us-east-1", "eu-west-1"]
        },
        "url": {
          "title": "Region URL",
          "description": "Base URL of the OJS server in this region.",
          "type": "string",
          "format": "uri",
          "examples": ["https://ojs-us-east-1.example.com"]
        },
        "weight": {
          "title": "Routing Weight",
          "description": "Routing weight for weighted load balancing. Higher values receive proportionally more traffic.",
          "type": "integer",
          "minimum": 0,
          "default": 1,
          "examples": [1, 2, 5]
        },
        "tags": {
          "title": "Region Tags",
          "description": "Arbitrary tags for filtering regions (e.g., capability-based routing).",
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1,
            "maxLength": 64
          },
          "uniqueItems": true,
          "default": [],
          "examples": [["gpu", "high-memory"], ["gdpr"]]
        }
      },
      "additionalProperties": false
    },
    "federationRegistry": {
      "title": "Federation Registry",
      "description": "The complete federation configuration containing all participating regions.",
      "type": "object",
      "required": ["federation_id", "regions"],
      "properties": {
        "federation_id": {
          "title": "Federation Identifier",
          "description": "A human-readable identifier for this federation deployment.",
          "type": "string",
          "minLength": 1,
          "maxLength": 128,
          "examples": ["prod-global", "staging-us-eu"]
        },
        "regions": {
          "title": "Regions",
          "description": "The list of regions participating in this federation.",
          "type": "array",
          "items": { "$ref": "#/definitions/regionEntry" },
          "minItems": 1,
          "uniqueItems": true
        }
      },
      "additionalProperties": false
    },
    "circuitBreakerConfig": {
      "title": "Circuit Breaker Configuration",
      "description": "Per-region circuit breaker settings to prevent cascading failures.",
      "type": "object",
      "properties": {
        "failure_threshold": {
          "title": "Failure Threshold",
          "description": "Number of consecutive failures before the circuit breaker opens.",
          "type": "integer",
          "minimum": 1,
          "default": 5,
          "examples": [3, 5, 10]
        },
        "cooldown_seconds": {
          "title": "Cooldown Period",
          "description": "Seconds to wait in the open state before transitioning to half-open.",
          "type": "integer",
          "minimum": 1,
          "default": 30,
          "examples": [15, 30, 60]
        }
      },
      "additionalProperties": false
    },
    "failoverConfig": {
      "title": "Failover Configuration",
      "description": "Controls how the federation layer handles region failures.",
      "type": "object",
      "properties": {
        "enabled": {
          "title": "Enabled",
          "description": "Whether automatic failover is enabled.",
          "type": "boolean",
          "default": true
        },
        "max_redirects": {
          "title": "Max Redirects",
          "description": "Maximum number of regions to try before returning an error.",
          "type": "integer",
          "minimum": 0,
          "default": 3,
          "examples": [1, 3, 5]
        },
        "exclude_regions": {
          "title": "Excluded Regions",
          "description": "Regions that should never be selected as failover targets.",
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "examples": [["ap-south-1"]]
        },
        "prefer_regions": {
          "title": "Preferred Regions",
          "description": "Ordered list of preferred failover target regions.",
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "examples": [["us-east-1", "eu-west-1"]]
        }
      },
      "additionalProperties": false
    },
    "regionHealthStatus": {
      "title": "Region Health Status",
      "description": "Health status of a single region as returned by federation health endpoints.",
      "type": "object",
      "required": ["id", "status"],
      "properties": {
        "id": {
          "title": "Region ID",
          "type": "string",
          "examples": ["us-east-1"]
        },
        "url": {
          "title": "Region URL",
          "type": "string",
          "format": "uri"
        },
        "status": {
          "title": "Health Status",
          "type": "string",
          "enum": ["healthy", "unhealthy", "unknown"],
          "examples": ["healthy"]
        },
        "latency_ms": {
          "title": "Latency (ms)",
          "description": "Last observed health check round-trip latency in milliseconds.",
          "type": ["integer", "null"],
          "minimum": 0,
          "examples": [12, 85, null]
        },
        "circuit_breaker": {
          "title": "Circuit Breaker State",
          "type": "string",
          "enum": ["closed", "open", "half-open"],
          "examples": ["closed"]
        },
        "replication_lag_ms": {
          "title": "Replication Lag (ms)",
          "description": "Estimated replication lag in milliseconds. Null if replication is not configured or the region is unreachable.",
          "type": ["integer", "null"],
          "minimum": 0,
          "examples": [0, 450, null]
        },
        "last_health_check": {
          "title": "Last Health Check",
          "description": "Timestamp of the last health check attempt.",
          "type": "string",
          "format": "date-time",
          "examples": ["2026-03-15T10:30:00Z"]
        }
      },
      "additionalProperties": false
    },
    "federationHealthResponse": {
      "title": "Federation Health Response",
      "description": "Aggregate health status for the entire federation.",
      "type": "object",
      "required": ["status", "healthy_regions", "total_regions", "regions"],
      "properties": {
        "status": {
          "title": "Overall Status",
          "description": "Aggregate federation health: healthy (all regions up), degraded (some regions down), unhealthy (no regions available).",
          "type": "string",
          "enum": ["healthy", "degraded", "unhealthy"],
          "examples": ["healthy", "degraded"]
        },
        "healthy_regions": {
          "title": "Healthy Region Count",
          "type": "integer",
          "minimum": 0
        },
        "total_regions": {
          "title": "Total Region Count",
          "type": "integer",
          "minimum": 1
        },
        "regions": {
          "title": "Region Statuses",
          "type": "array",
          "items": { "$ref": "#/definitions/regionHealthStatus" }
        }
      },
      "additionalProperties": false
    },
    "routeRequest": {
      "title": "Route Request",
      "description": "Request body for the route resolution endpoint.",
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "title": "Job Type",
          "type": "string",
          "examples": ["email.send"]
        },
        "meta": {
          "title": "Job Metadata",
          "description": "Metadata containing federation routing hints.",
          "type": "object",
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "routeResponse": {
      "title": "Route Response",
      "description": "Response from the route resolution endpoint.",
      "type": "object",
      "required": ["target_region", "strategy"],
      "properties": {
        "target_region": {
          "title": "Target Region",
          "description": "The selected target region for the job.",
          "type": "string",
          "examples": ["us-east-1"]
        },
        "strategy": {
          "title": "Routing Strategy",
          "type": "string",
          "enum": ["affinity", "overflow", "geo-pin"],
          "examples": ["affinity"]
        },
        "candidates": {
          "title": "Candidate Regions",
          "description": "Ranked list of candidate regions considered during routing.",
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "score", "reason"],
            "properties": {
              "id": {
                "type": "string",
                "examples": ["us-east-1"]
              },
              "score": {
                "type": "number",
                "minimum": 0,
                "maximum": 1,
                "examples": [0.95]
              },
              "reason": {
                "type": "string",
                "examples": ["local, healthy"]
              }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    }
  }
}
